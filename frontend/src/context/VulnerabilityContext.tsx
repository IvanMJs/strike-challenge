import { createContext, useContext, useReducer, ReactNode, Dispatch } from 'react';
import { Vulnerability } from '../types/vulnerability';
import { 
  vulnerabilityReducer, 
  VulnerabilityAction, 
  initialState,
  Filters
} from '../reducers/vulnerabilityReducer';

interface VulnerabilityContextType {
  vulnerabilities: Vulnerability[];
  filteredVulnerabilities: Vulnerability[];
  loading: boolean;
  error: string | null;
  filters: Filters;
  dispatch: Dispatch<VulnerabilityAction>;
}

export const VulnerabilityContext = createContext<VulnerabilityContextType | undefined>(undefined);

interface VulnerabilityProviderProps {
  children: ReactNode;
}

export function VulnerabilityProvider({ children }: VulnerabilityProviderProps) {
  const [state, dispatch] = useReducer(vulnerabilityReducer, initialState);

  return (
    <VulnerabilityContext.Provider      value={{
        vulnerabilities: state.vulnerabilities,
        filteredVulnerabilities: state.vulnerabilities.filter(v => {
          const { status, criticality, search } = state.filters;
          return (
            (!status || v.status === status) &&
            (!criticality || v.criticality === criticality) &&
            (!search || 
              v.title.toLowerCase().includes(search.toLowerCase()) ||
              v.description.toLowerCase().includes(search.toLowerCase()) ||
              v.cwe.toLowerCase().includes(search.toLowerCase())
            )
          );
        }),
        loading: state.loading,
        error: state.error,
        filters: state.filters,
        dispatch
      }}
    >
      {children}
    </VulnerabilityContext.Provider>
  );
}

export function useVulnerabilities() {
  const context = useContext(VulnerabilityContext);
  if (context === undefined) {
    throw new Error('useVulnerabilities must be used within a VulnerabilityProvider');
  }
  return context;
}
