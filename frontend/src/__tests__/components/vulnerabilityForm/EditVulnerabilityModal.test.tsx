import { describe, it, expect, vi } from 'vitest';
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import '@testing-library/jest-dom';
import EditVulnerabilityModal from '../../../components/vulnerabilityForm/EditVulnerabilityModal';
import { Vulnerability } from '../../../types/vulnerability';
import { STATES, CRITICALITY_OPTIONS } from '../../../utils/constants';

const mockVulnerability: Vulnerability = {
    id: '1',
    title: 'Test Vulnerability',
    description: 'Test Description',
    criticality: 'High',
    status: STATES.PENDING,
    cwe: 'CWE-79',
    createdAt: new Date().toISOString(),
    history: []
};

describe('EditVulnerabilityModal', () => {
    const mockOnClose = vi.fn();
    const mockOnSave = vi.fn();

    beforeEach(() => {
        vi.clearAllMocks();
    });

    it('renders the modal with vulnerability data', () => {
        render(
            <EditVulnerabilityModal
                isOpen={true}
                onClose={mockOnClose}
                onSave={mockOnSave}
                vulnerability={mockVulnerability}
                STATES={STATES}
            />
        );

        expect(screen.getByTestId('edit-vulnerability-modal')).toBeInTheDocument();
        expect(screen.getByLabelText('Title')).toHaveValue(mockVulnerability.title);
        expect(screen.getByLabelText('Description')).toHaveValue(mockVulnerability.description);
        expect(screen.getByLabelText('CWE')).toHaveValue(mockVulnerability.cwe);
    });

    it('calls onClose when close button is clicked', async () => {
        render(
            <EditVulnerabilityModal
                isOpen={true}
                onClose={mockOnClose}
                onSave={mockOnSave}
                vulnerability={mockVulnerability}
                STATES={STATES}
            />
        );

        const closeButton = screen.getByRole('button', { name: /cancel/i });
        await userEvent.click(closeButton);

        expect(mockOnClose).toHaveBeenCalled();
    });

    it('calls onSave with updated vulnerability when save button is clicked', async () => {
        render(
            <EditVulnerabilityModal
                isOpen={true}
                onClose={mockOnClose}
                onSave={mockOnSave}
                vulnerability={mockVulnerability}
                STATES={STATES}
            />
        );

        const titleInput = screen.getByLabelText('Title');
        await userEvent.clear(titleInput);
        await userEvent.type(titleInput, 'Updated Title');

        const form = screen.getByTestId('edit-vulnerability-form');
        await userEvent.click(screen.getByRole('button', { name: /save/i }));

        expect(mockOnSave).toHaveBeenCalledWith({
            ...mockVulnerability,
            title: 'Updated Title'
        });
    });

    it('handles form changes correctly', async () => {
        render(
            <EditVulnerabilityModal
                isOpen={true}
                onClose={mockOnClose}
                onSave={mockOnSave}
                vulnerability={mockVulnerability}
                STATES={STATES}
            />
        );

        const descriptionInput = screen.getByLabelText('Description');
        await userEvent.clear(descriptionInput);
        await userEvent.type(descriptionInput, 'New Description');

        const form = screen.getByTestId('edit-vulnerability-form');
        await userEvent.click(screen.getByRole('button', { name: /save/i }));

        expect(mockOnSave).toHaveBeenCalledWith({
            ...mockVulnerability,
            description: 'New Description'
        });
    });

    it('validates required fields before saving', async () => {
        render(
            <EditVulnerabilityModal
                isOpen={true}
                onClose={mockOnClose}
                onSave={mockOnSave}
                vulnerability={mockVulnerability}
                STATES={STATES}
            />
        );

        const titleInput = screen.getByLabelText('Title');
        await userEvent.clear(titleInput);

        const form = screen.getByTestId('edit-vulnerability-form');
        await userEvent.click(screen.getByRole('button', { name: /save/i }));

        expect(mockOnSave).not.toHaveBeenCalled();
        expect(titleInput).toBeInvalid();
    });
});
